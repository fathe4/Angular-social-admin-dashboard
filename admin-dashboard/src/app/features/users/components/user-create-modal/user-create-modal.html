<p-dialog 
  [(visible)]="visible"
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '500px' }"
  header="Create User"
  (onHide)="hide()"
  (onClose)="onClose()"
  (onShow)="onShow()"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  class="clean-modal">
  
  <!-- Loading Overlay -->
  <div *ngIf="loading()" class="absolute inset-0 bg-white/90 z-40 flex items-center justify-center rounded-lg pointer-events-none">
    <div class="flex items-center space-x-3">
      <div class="animate-spin rounded-full h-5 w-5 border-2 border-gray-400 border-t-gray-800"></div>
      <span class="text-sm text-gray-600">Creating user...</span>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="success()" class="mb-4 p-3 bg-green-50 border border-green-200 rounded text-center">
    <span class="text-sm text-green-800">{{ success() }}</span>
  </div>

  <!-- Error Message -->
  <div *ngIf="error()" class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-center">
    <span class="text-sm text-red-800">{{ error() }}</span>
  </div>

  <!-- Clean Form -->
  <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="space-y-4">
    
    <!-- Name Fields -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm text-gray-700 mb-1">First Name</label>
        <input 
          pInputText 
          formControlName="first_name"
          placeholder="First name"
          autocomplete="given-name"
          class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm"
          [class.border-red-300]="isFieldInvalid('first_name')">
        <div *ngIf="isFieldInvalid('first_name')" class="text-xs text-red-600 mt-1">
          {{ getFieldError('first_name') }}
        </div>
      </div>
      
      <div>
        <label class="block text-sm text-gray-700 mb-1">Last Name</label>
        <input 
          pInputText 
          formControlName="last_name"
          placeholder="Last name"
          autocomplete="family-name"
          class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm"
          [class.border-red-300]="isFieldInvalid('last_name')">
        <div *ngIf="isFieldInvalid('last_name')" class="text-xs text-red-600 mt-1">
          {{ getFieldError('last_name') }}
        </div>
      </div>
    </div>

    <!-- Username -->
    <div>
      <label class="block text-sm text-gray-700 mb-1">Username</label>
      <input 
        pInputText 
        formControlName="username"
        placeholder="Username"
        autocomplete="username"
        class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm"
        [class.border-red-300]="isFieldInvalid('username')">
      <div *ngIf="isFieldInvalid('username')" class="text-xs text-red-600 mt-1">
        {{ getFieldError('username') }}
      </div>
    </div>

    <!-- Email -->
    <div>
      <label class="block text-sm text-gray-700 mb-1">Email</label>
      <input 
        pInputText 
        type="email"
        formControlName="email"
        placeholder="user@example.com"
        autocomplete="email"
        class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm"
        [class.border-red-300]="isFieldInvalid('email')">
      <div *ngIf="isFieldInvalid('email')" class="text-xs text-red-600 mt-1">
        {{ getFieldError('email') }}
      </div>
    </div>

    <!-- Password -->
    <div>
      <label class="block text-sm text-gray-700 mb-1">Password</label>
      <div class="relative">
        <input 
          [type]="showPassword ? 'text' : 'password'"
          formControlName="password"
          placeholder="Password"
          autocomplete="new-password"
          class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm pr-10"
          [class.border-red-300]="isFieldInvalid('password')">
        <button 
          type="button"
          (click)="togglePassword()"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
          <i [class]="showPassword ? 'pi pi-eye-slash' : 'pi pi-eye'" class="text-sm"></i>
        </button>
      </div>
      <div class="flex justify-between items-center mt-1">
        <div *ngIf="isFieldInvalid('password')" class="text-xs text-red-600">
          {{ getFieldError('password') }}
        </div>
        <div *ngIf="userForm.get('password')?.value && !isFieldInvalid('password')" 
             class="text-xs" 
             [ngClass]="getPasswordStrengthColor()">
          {{ getPasswordStrength() }}
        </div>
      </div>
    </div>

    <!-- Role -->
    <div>
      <label class="block text-sm text-gray-700 mb-1">Role</label>
      <p-select 
        formControlName="role"
        [options]="roleOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="Select role"
        styleClass="w-full"
        panelStyleClass="text-sm">
      </p-select>
    </div>

    <!-- Status Fields -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm text-gray-700 mb-1">Verification</label>
        <p-select 
          formControlName="is_verified"
          [options]="verificationOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select"
          styleClass="w-full"
          panelStyleClass="text-sm">
        </p-select>
      </div>

      <div>
        <label class="block text-sm text-gray-700 mb-1">Status</label>
        <p-select 
          formControlName="is_active"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select"
          styleClass="w-full"
          panelStyleClass="text-sm">
        </p-select>
      </div>
    </div>

    <!-- Optional Fields (Collapsible) -->
    <div class="border-t pt-4">
      <button 
        type="button"
        (click)="toggleOptionalFields()"
        class="flex items-center text-sm text-gray-600 hover:text-gray-800 mb-3">
        <i [class]="showOptionalFields ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" class="mr-2 text-xs"></i>
        Optional Information
      </button>
      
      <div *ngIf="showOptionalFields" class="space-y-4">
        <!-- Bio -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Bio</label>
          <textarea 
            pInputTextarea
            formControlName="bio"
            placeholder="Brief description..."
            rows="3"
            class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm resize-none">
          </textarea>
        </div>

        <!-- Location -->
        <div>
          <label class="block text-sm text-gray-700 mb-1">Location</label>
          <input 
            pInputText 
            formControlName="location"
            placeholder="City, Country"
            class="w-full px-3 py-2 border border-gray-200 rounded focus:outline-none focus:border-gray-400 text-sm">
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-end space-x-2 pt-4 border-t">
      <button 
        type="button"
        (click)="hide()"
        class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
        Cancel
      </button>
      <p-button 
        label="Create User" 
        type="submit"
        [disabled]="loading() || userForm.invalid"
        class="transition-all duration-200 bg-indigo-600!">
      </p-button>
      <!-- <button 
        type="submit"
        [disabled]="loading() || userForm.invalid"
        class="px-4 py-2 bg-black text-white text-sm rounded hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed">
        Create User
      </button> -->
    </div>
  </form>
</p-dialog>