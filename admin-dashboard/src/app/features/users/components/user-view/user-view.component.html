<!-- Loading State -->
@if (loading()) {
  <div class="flex justify-center items-center h-64">
    <p-progressSpinner [style]="{ width: '50px', height: '50px' }"></p-progressSpinner>
  </div>
}

<!-- Error State -->
@if (error() && !loading()) {
  <div class="w-full my-6">
    <p-message 
      severity="error" 
      [text]="error()!" 
      [closable]="false">
    </p-message>
    <div class="mt-4">
      <p-button 
        label="Retry" 
        icon="pi pi-refresh" 
        (onClick)="refreshUserDetails()">
      </p-button>
    </div>
  </div>
}

<!-- Main Content -->
@if (user() && !loading() && !error()) {
  <div class="w-full flex flex-col md:flex-row gap-8 my-6">
    <!-- Profile Card -->
    <div class="w-full md:w-1/3">
      <p-card class="shadow-md rounded-2xl border border-gray-200">
        <div class="flex flex-col gap-6">
          
          <!-- Avatar + Basic Info + Actions -->
          <div class="flex justify-between items-start">
            <div class="flex gap-4 items-center">
              <p-avatar
                [image]="user()?.profile_picture"
                size="xlarge"
                shape="circle"
              ></p-avatar>

              <div>
                <h2 class="m-0 text-xl font-semibold text-gray-900">
                  {{ user()?.first_name }} {{ user()?.last_name }}
                </h2>
                <p class="m-0 text-gray-500 text-sm">@{{ user()?.username }}</p>
                
                <div class="flex flex-wrap gap-2 mt-2">
                  <p-tag
                    [value]="user()?.role"
                    [severity]="getRoleBadgeSeverity(user()?.role!)"
                  ></p-tag>
                  <p-tag
                    [value]="user()?.is_active ? 'Active' : 'Inactive'"
                    [severity]="getStatusBadgeSeverity(user()?.is_active!)"
                  ></p-tag>
                  <p-tag
                    [value]="user()?.is_verified ? 'Verified' : 'Unverified'"
                    [severity]="getVerificationBadgeSeverity(user()?.is_verified!)"
                  ></p-tag>
                </div>
              </div>
            </div>

            <div class="flex gap-2">
              <p-button
                icon="pi pi-refresh"
                severity="info"
                size="small"
                rounded
                (onClick)="refreshUserDetails()"
                [loading]="loading()"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                severity="danger"
                size="small"
                rounded
                (onClick)="onDeleteUser()"
              ></p-button>
            </div>
          </div>

          <!-- Bio Section -->
          @if (user()?.bio) {
            <div class="border-t pt-4">
              <h5 class="text-gray-900 font-semibold text-base mb-3">About</h5>
              <p class="text-gray-600 text-sm">{{ user()?.bio }}</p>
            </div>
          }

          <!-- Contact Info -->
          <div class="border-t pt-4">
            <h5 class="text-gray-900 font-semibold text-base mb-3">
              Contact Information
            </h5>
            <div class="grid text-sm">
              <div class="col-12 md:col-6 flex items-center gap-2 mb-2" *ngIf="user()?.email">
                <i class="pi pi-envelope text-gray-500"></i>
                <span>{{ user()?.email }}</span>
              </div>
              <div class="col-12 md:col-6 flex items-center gap-2 mb-2" *ngIf="user()?.contact_info?.['phone']">
                <i class="pi pi-phone text-gray-500"></i>
                <span>{{ user()?.contact_info?.['phone'] }}</span>
              </div>
              <div class="col-12 md:col-6 flex items-center gap-2 mb-2" *ngIf="user()?.contact_info?.['website']">
                <i class="pi pi-globe text-gray-500"></i>
                <a
                  [href]="user()?.contact_info?.['website']"
                  target="_blank"
                  class="text-primary hover:underline"
                >
                  {{ getWebsiteDomain(user()?.contact_info?.['website']!) }}
                </a>
              </div>
            </div>
          </div>

          <!-- Location Information -->
          <div class="border-t pt-4">
            <h5 class="text-gray-900 font-semibold text-base mb-3">
              Location Information
            </h5>
            <div class="grid text-sm">
              <!-- Profile Location (from user profile) -->
              <div class="col-12 flex items-center gap-2 mb-2" *ngIf="user()?.location?.profile">
                <i class="pi pi-map-marker text-blue-500"></i>
                <div class="flex flex-col">
                  <span class="text-xs text-gray-500 uppercase tracking-wide">Profile Location</span>
                  <span class="font-medium">{{ user()?.location?.profile }}</span>
                </div>
              </div>
              
              <!-- Current Location (from GPS/device) -->
              <div class="col-12 flex items-center gap-2 mb-2" *ngIf="user()?.location?.current">
                <i class="pi pi-map-marker text-green-500"></i>
                <div class="flex flex-col">
                  <span class="text-xs text-gray-500 uppercase tracking-wide">Current Location</span>
                  <span class="font-medium">
                    {{ user()?.location?.current?.city }}{{ user()?.location?.current?.country ? ', ' + user()?.location?.current?.country : '' }}
                  </span>
                  @if (user()?.location?.current?.accuracy) {
                    <span class="text-xs text-gray-400">Â±{{ user()?.location?.current?.accuracy }}m accuracy</span>
                  }
                </div>
              </div>
              
              <!-- No location data message -->
              <div class="col-12 flex items-center gap-2 mb-2 text-gray-400" 
                   *ngIf="!user()?.location?.profile && !user()?.location?.current">
                <i class="pi pi-info-circle"></i>
                <span class="text-sm">No location information available</span>
              </div>
            </div>
          </div>

          <!-- Profile Details -->
          @if (profileData()) {
            <div class="border-t pt-4">
              <h5 class="text-gray-900 font-semibold text-base mb-3">Profile Details</h5>
              <div class="grid text-sm">
                @if (profileData()?.occupation) {
                  <div class="col-12 flex items-center gap-2 mb-2">
                    <i class="pi pi-briefcase text-gray-500"></i>
                    <span>{{ profileData()?.occupation }}</span>
                  </div>
                }
                @if (profileData()?.education) {
                  <div class="col-12 flex items-center gap-2 mb-2">
                    <i class="pi pi-graduation-cap text-gray-500"></i>
                    <span>{{ profileData()?.education }}</span>
                  </div>
                }
                @if (profileData()?.relationship_status) {
                  <div class="col-12 flex items-center gap-2 mb-2">
                    <i class="pi pi-heart text-gray-500"></i>
                    <span>{{ profileData()?.relationship_status }}</span>
                  </div>
                }
                <!-- @if (profileData()?.interests && profileData()?.interests.length > 0) {
                  <div class="col-12 mt-2">
                    <div class="flex flex-wrap gap-1">
                      @for (interest of profileData()?.interests; track interest) {
                        <p-chip [label]="interest" size="small"></p-chip>
                      }
                    </div>
                  </div>
                } -->
              </div>
            </div>
          }

          <!-- Member Since -->
          <div class="border-t pt-4">
            <h5 class="text-gray-900 font-semibold text-base mb-3">
              Member Since
            </h5>
            <div class="flex items-center gap-2 text-sm">
              <i class="pi pi-calendar text-gray-500"></i>
              <span>{{ formatDate(user()?.created_at!) }}</span>
              <span class="text-gray-400">({{ getJoinDuration() }})</span>
            </div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Content Section -->
    <div class="w-full md:w-2/3">
      <!-- Stats Cards -->
      <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Marketplace Stats -->
        @if (marketplaceData()) {
          <p-card class="text-center">
            <div class="text-2xl font-bold text-blue-600">{{ marketplaceData()?.activeListingsCount || 0 }}</div>
            <div class="text-sm text-gray-600">Active Listings</div>
          </p-card>
          
          <p-card class="text-center">
            <div class="text-2xl font-bold text-green-600">{{ marketplaceData()?.totalListingsCount || 0 }}</div>
            <div class="text-sm text-gray-600">Total Listings</div>
          </p-card>
          
          <p-card class="text-center">
            <div class="text-2xl font-bold text-purple-600">{{ marketplaceData()?.averageRating || 0 }}</div>
            <div class="text-sm text-gray-600">Avg Rating</div>
          </p-card>
          
          <p-card class="text-center">
            <div class="text-2xl font-bold text-orange-600">{{ marketplaceData()?.totalRatings || 0 }}</div>
            <div class="text-sm text-gray-600">Total Ratings</div>
          </p-card>
        }
      </div>

      <!-- Subscription Info -->
      @if (subscriptionData()?.isActive) {
        <p-card class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h5 class="text-lg font-semibold text-gray-900 mb-2">Active Subscription</h5>
              <p class="text-gray-600">{{ subscriptionData()?.tier?.name }} - ${{ subscriptionData()?.tier?.price }}/month</p>
            </div>
            <p-tag 
              [value]="subscriptionData()?.status" 
              severity="success">
            </p-tag>
          </div>
        </p-card>
      }

      <!-- Tabs -->
      <div class="mb-4">
        <p-tabs>
          <p-tablist>
            <div class="flex justify-center flex-row gap-2">
              @for(tab of tabs(); track tab.id) {
                <p-tab
                  [value]="tab.id"
                  [routerLink]="tab.route"
                  routerLinkActive="p-highlight"
                  class="flex gap-2 items-center text-gray-700 hover:text-primary transition"
                >
                  <i [class]="tab.icon"></i>
                  <span>{{ tab.label }}</span>
                </p-tab>
              }
            </div>
          </p-tablist>
        </p-tabs>
      </div>

      <div class="mt-6">
        <router-outlet></router-outlet>
      </div>
    </div>
  </div>
}
